# 🚀 快速启动指南

## ✅ 错误已修复

刚刚修复了三个错误：
1. ✅ 服务端路由语法错误（`/check/:path(*)` → `/check`）
2. ✅ 前端导入路径错误（`@/hooks/use-auth` → `@/stores/authStore`）
3. ✅ 用户ID字段错误（`req.user.id` → `req.user.userId`）

## 📋 现在执行以下步骤

### 1️⃣ 确保服务器已停止
按 `Ctrl+C` 停止服务器

### 2️⃣ 生成 Prisma Client
```bash
npx prisma generate
```

### 3️⃣ 同步数据库（创建 routes 表）
```bash
npx prisma db push
```

### 4️⃣ 添加路由权限
```bash
node fix-permissions.js
```

你会看到：
```
========================================
  快速修复：添加路由权限
========================================

[1/4] 检查并创建route权限...
✓ 创建/更新了 7 个route权限

[2/4] 查找现有角色...
✓ 找到 2 个角色:
   - admin_a (管理员 A)
   - admin_b (管理员 B)

[3/4] 为角色分配权限...
✓ 为 admin_a 分配了 7 个route权限
✓ 为 admin_b 分配了 READ route 权限

[4/4] 验证权限分配...
✓ 已分配 8 个route权限
```

### 5️⃣ 初始化路由菜单数据
```bash
node seed-routes.js
```

你会看到：
```
========================================
  初始化路由数据
========================================

[1/3] 创建顶级路由...
✓ 创建了 2 个顶级路由

[2/3] 创建子路由...
✓ 创建了 4 个子路由

[3/3] 分配路由权限...
✓ 分配了 4 个路由权限
```

### 6️⃣ 重启服务器
```bash
npm run dev
```

### 7️⃣ 重新登录系统

1. 打开浏览器访问 http://localhost:5173
2. 如果已登录，先退出登录
3. 使用 **admin_a** 账号登录：
   - 用户名：`admin_a`
   - 密码：`admin123456`

## 🎉 查看效果

登录后你会看到：

### ✨ 动态侧边栏菜单
- 菜单会根据用户权限自动加载
- admin_a 可以看到所有菜单
- admin_b 只能看到有权限的菜单

### 📊 预期的菜单结构

```
系统菜单
  ├─ 仪表盘 (/)
  ├─ 用户管理
  │   ├─ 用户列表 (/users)
  │   ├─ 角色管理 (/roles)
  │   └─ 权限管理 (/permissions)
  └─ 路由管理 (/routes)
```

## 🧪 测试权限控制

### 测试 admin_a（全部权限）
1. 登录 admin_a
2. 访问**角色管理**页面
3. 点击"创建角色"按钮 → ✅ 可以看到
4. 创建一个角色 → ✅ 成功
5. 访问**路由管理**页面 → ✅ 可以访问
6. 点击"创建路由"按钮 → ✅ 可以看到

### 测试 admin_b（有限权限）
1. 退出登录
2. 使用 admin_b 登录：
   - 用户名：`admin_b`
   - 密码：`admin123456`
3. 侧边栏应该显示相同的菜单（因为都有 READ 权限）
4. 访问**角色管理**页面
5. "创建角色"按钮应该 → ❌ 不显示（没有 CREATE 权限）
6. 访问**路由管理**页面 → ✅ 可以访问
7. "创建路由"按钮应该 → ❌ 不显示（没有 CREATE 权限）

## 🎯 权限系统功能

### 已实现的功能

| 功能 | 说明 |
|------|------|
| ✅ 动态菜单 | 侧边栏根据用户权限自动显示 |
| ✅ 路由过滤 | 后端自动过滤用户有权访问的路由 |
| ✅ 按钮权限 | 使用 `<PermissionGuard>` 控制按钮显示 |
| ✅ API 权限 | 服务端强制验证权限 |
| ✅ 可视化管理 | 在路由管理页面配置菜单和权限 |
| ✅ 角色分配 | 在角色管理页面分配权限 |

### 权限流程

```
用户登录
  ↓
获取用户角色
  ↓
收集角色权限
  ↓
过滤可访问路由
  ↓
动态生成侧边栏菜单
```

## 📚 配置新菜单

### 方法 1：使用路由管理页面（推荐）

1. 登录 admin_a 账号
2. 访问**路由管理**页面
3. 点击"创建路由"
4. 填写表单：
   - 路由路径：`/new-page`
   - 路由名称：`new-page`
   - 标题：`新页面`
   - 图标：`IconSettings`（可选）
   - 父路由：选择父菜单（可选）
   - 排序：数字越小越靠前
   - 权限配置：选择访问此路由需要的权限
5. 保存
6. 刷新页面，侧边栏自动更新！

### 方法 2：使用脚本

编辑 `seed-routes.js` 添加新路由：

```javascript
const newRoute = await prisma.route.upsert({
  where: { path: '/new-page' },
  update: {},
  create: {
    path: '/new-page',
    name: 'new-page',
    title: '新页面',
    icon: 'IconSettings',
    order: 30,
    hidden: false,
  },
})
```

然后运行：
```bash
node seed-routes.js
```

## 🔧 自定义权限

### 为路由分配权限

在路由管理页面编辑路由时，勾选需要的权限。

例如：
- 只勾选 `user:READ` → 只有有"查看用户"权限的角色才能看到此菜单
- 勾选多个权限 → 满足任意一个权限即可访问（OR 逻辑）

### 为角色分配权限

1. 访问**角色管理**页面
2. 编辑角色
3. 在"权限配置"中勾选需要的权限
4. 保存
5. 该角色的用户重新登录后生效

## ⚠️ 常见问题

### Q: 侧边栏显示"加载菜单中..."一直不动

**检查：**
1. 服务端是否正常运行？
2. 浏览器控制台是否有错误？
3. 检查 `/api/menus` 接口返回

**解决：**
```bash
# 检查服务端日志
# 查看是否有数据库连接错误或其他错误
```

### Q: 侧边栏是空的

**原因：** routes 表没有数据

**解决：**
```bash
node seed-routes.js
```

### Q: 修改了路由但侧边栏没更新

**原因：** React Query 缓存（5分钟）

**解决：**
- 方法 1：刷新页面（F5）
- 方法 2：重新登录
- 方法 3：清除浏览器缓存

### Q: 提示"您没有权限"

**原因：** 当前角色没有对应权限

**解决：**
1. 使用 admin_a 账号登录（有所有权限）
2. 或在角色管理中为当前角色添加权限

## 🎊 完成！

现在你的系统已经实现了完整的权限控制：
- ✅ 用户登录
- ✅ 角色管理
- ✅ 权限控制
- ✅ 动态菜单
- ✅ 路由管理

开始享受完整的 RBAC 权限系统吧！🚀

---

需要更多帮助？查看 `SETUP-COMPLETE-SYSTEM.md` 获取详细文档。
